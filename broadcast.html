<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Emoji Broadcast</title>
  <style>
    body { background:#111; color:white; font-family:monospace; text-align:center; }
    video { display:none; }
    pre { font-size:2px; line-height:2px; white-space:pre; }
  </style>
</head>
<body>
<h1>ðŸŽ¥ Emoji Broadcast</h1>
<video id="video" autoplay playsinline></video>
<canvas id="canvas" width="64" height="36" style="display:none"></canvas>
<pre id="emoji"></pre>

<script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
<script>
const peer = new Peer('broadcaster', {host:'peerjs.com', port:443, secure:true});
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const emojiPre = document.getElementById('emoji');

const colors = [
  {emoji:"â¬›", r:0,g:0,b:0},{emoji:"ðŸŸ¥",r:255,g:0,b:0},{emoji:"ðŸŸ§",r:255,g:165,b:0},
  {emoji:"ðŸŸ¨",r:255,g:255,b:0},{emoji:"ðŸŸ©",r:0,g:255,b:0},{emoji:"ðŸŸ¦",r:0,g:0,b:255},
  {emoji:"ðŸŸª",r:128,g:0,b:128},{emoji:"â¬œ",r:255,g:255,b:255}
];

function getEmoji(r,g,b){
  let closest=colors[0]; let minDist=Infinity;
  for(const c of colors){ const dist=(r-c.r)**2+(g-c.g)**2+(b-c.b)**2; if(dist<minDist){minDist=dist;closest=c;} }
  return closest.emoji;
}

async function startCamera(){
  const stream = await navigator.mediaDevices.getUserMedia({video:true});
  video.srcObject = stream;
  setInterval(captureFrame, 200); // send ~5 fps
}

function captureFrame(){
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  const data=ctx.getImageData(0,0,canvas.width,canvas.height).data;
  let output="";
  for(let y=0;y<canvas.height;y++){
    for(let x=0;x<canvas.width;x++){
      const i=(y*canvas.width+x)*4;
      output+=getEmoji(data[i],data[i+1],data[i+2]);
    }
    output+="\n";
  }
  emojiPre.textContent=output;

  // send to viewers
  peer.connections.forEach(conn=>{
    conn.forEach(c=>{
      c.send(output);
    });
  });
}

peer.on('connection', conn=>{
  console.log("Viewer connected");
});
startCamera();
</script>
</body>
</html>
